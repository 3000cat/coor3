<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜Ÿæ˜Ÿåœ‹ Scratch åº§æ¨™å¤§æŒ‘æˆ°</title>
    <!-- å¼•å…¥ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: radial-gradient(circle at center, #f8fbff 0%, #eef6ff 100%);
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            color: #333;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* èƒŒæ™¯è£é£¾ (æ˜Ÿæ˜Ÿ) */
        .bg-star {
            position: absolute;
            color: rgba(255, 171, 25, 0.2);
            z-index: 0;
            animation: twinkle-bg 4s infinite ease-in-out;
        }
        @keyframes twinkle-bg { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }

        /* å°è¦½åˆ— - æ¥µç°¡ */
        .navbar {
            flex-shrink: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 2px 10px; 
            box-shadow: 0 2px 10px rgba(76, 151, 255, 0.1);
            z-index: 100;
            height: 40px;
        }

        .nav-brand {
            font-weight: 900;
            color: #4C97FF;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
            letter-spacing: 1px;
        }

        .nav-cat-icon {
            font-size: 1.4rem;
            color: #FFAB19;
            filter: drop-shadow(0 2px 0px #CC8914);
            transition: transform 0.3s ease;
        }
        
        .nav-brand:hover .nav-cat-icon {
            transform: rotate(-10deg) scale(1.2);
        }

        .nav-links { display: flex; gap: 5px; }

        /* å°è¦½åˆ—å°æŒ‰éˆ•æ¨£å¼ */
        .nav-btn {
            background: #fff;
            border: 2px solid #e0e6ed;
            color: #666;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            box-shadow: 0 2px 0 #d1d9e6;
        }

        .nav-btn:active {
            transform: translateY(2px);
            box-shadow: none;
            background: #f0f4f8;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            flex-grow: 1;
            width: 100%;
            padding: 5px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        
        .game-content-wrapper {
            width: 100%;
            max-width: 900px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #game-ui {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
        }

        .status-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 2px;
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 12px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #fff;
        }

        /* ç•«å¸ƒå®¹å™¨ (è¶…ç´šæ”¾å¤§åœ–) */
        .stage-container {
            flex-shrink: 1; 
            flex-grow: 1; 
            position: relative;
            margin: 2px auto;
            border: 3px solid #4C97FF; 
            border-radius: 12px;
            background-color: #ffffff;
            overflow: hidden;
            box-shadow: 0 3px 0 #3373CC, inset 0 0 30px rgba(0,0,0,0.05);
            width: 100%;
            max-height: 80vh; 
            aspect-ratio: 4 / 3;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .question-area {
            flex-shrink: 0;
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
            margin-top: 5px;
        }

        .question-text {
            display: none; 
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px; 
            width: 100%;
            padding: 0 2px;
        }

        /* --- è¯éº—æŒ‰éˆ•æ¨£å¼ (å–®è¡Œç‰ˆ) --- */
        .game-btn {
            position: relative;
            border: none;
            outline: none;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 900; 
            color: white;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.3); 
            border-radius: 8px; 
            transition: transform 0.1s, filter 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0.05) 100%);
            border: 1px solid rgba(255,255,255,0.4);
        }

        /* é¸é …æŒ‰éˆ• */
        button.option-btn {
            background-color: #FFAB19; 
            background: linear-gradient(to bottom, #FFC14D, #FFAB19);
            box-shadow: 0 3px 0 #CC8914, 0 5px 5px rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.4);
            font-size: 1.3rem; 
            height: 45px;
            width: 100%;
            letter-spacing: 0;
            padding: 0 2px; 
            transform: translateY(0);
        }

        button.option-btn:active {
            box-shadow: 0 0 0 #CC8914, inset 0 2px 4px rgba(0,0,0,0.3) !important;
            transform: translateY(3px);
        }

        button.option-btn.correct { 
            background-color: #4CBF56 !important;
            background: linear-gradient(to bottom, #6BE576, #4CBF56) !important;
            box-shadow: 0 3px 0 #3A9E44, 0 5px 5px rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.4) !important;
        }
        
        button.option-btn.correct:active {
            box-shadow: 0 0 0 #3A9E44, inset 0 2px 4px rgba(0,0,0,0.3) !important;
        }

        button.option-btn.wrong { 
            background-color: #FF6680 !important;
            background: linear-gradient(to bottom, #FF8FAB, #FF6680) !important;
            box-shadow: 0 3px 0 #D9455F, 0 5px 5px rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.4) !important;
        }
        button.option-btn.wrong:active {
            box-shadow: 0 0 0 #D9455F, inset 0 2px 4px rgba(0,0,0,0.3) !important;
        }

        /* --- è¶…å¤§é–‹å§‹æŒ‰éˆ• --- */
        .big-btn {
            background-color: #4C97FF;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); 
            background: linear-gradient(180deg, #64B5F6 0%, #1976D2 100%);
            box-shadow: 0 10px 0 #0D47A1, 0 15px 25px rgba(25, 118, 210, 0.4), inset 0 4px 0 rgba(255,255,255,0.3);
            font-size: 3rem; 
            text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
            padding: 15px 80px;
            border-radius: 80px;
            margin-top: 20px;
            width: auto;
            min-width: 300px;
            letter-spacing: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .big-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            20% { transform: translateX(100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .big-btn:active { 
            transform: translateY(10px); 
            box-shadow: 0 0 0 #0D47A1, inset 0 3px 6px rgba(0,0,0,0.3) !important;
        }

        /* é–‹å§‹/çµæŸç•«é¢ */
        .start-screen {
            width: 100%;
            display: flex;
            flex-direction: row; /* é›»è…¦ç‰ˆå·¦å³æ’åˆ— */
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-bottom: 30px;
            gap: 40px; /* å·¦å³é–“è· */
        }

        .start-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1; /* ä½”æ“šç©ºé–“ */
        }

        .end-screen {
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-bottom: 30px;
        }

        /* æ¨™é¡Œæ¨£å¼ */
        h1.main-title {
            margin: 10px 0 20px 0;
            font-size: 4rem; 
            text-align: center;
            font-weight: 900;
            line-height: 1.2; 
            letter-spacing: 2px;
            color: #4C97FF; 
            text-shadow: 
                3px 3px 0px #fff, 
                -3px -3px 0px #fff,  
                3px -3px 0px #fff, 
                -3px 3px 0px #fff, 
                3px 0px 0px #fff, 
                -3px 0px 0px #fff, 
                0px 3px 0px #fff, 
                0px -3px 0px #fff,
                6px 6px 0px rgba(0,0,0,0.1), 
                8px 8px 15px rgba(76, 151, 255, 0.2); 
            position: relative;
        }

        .start-subtitle {
            font-size: 1.5rem;
            color: #555;
            margin-bottom: 20px;
            font-weight: bold;
            background: rgba(255,255,255,0.9);
            padding: 8px 30px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #fff;
        }

        .title-icon {
            font-size: 8rem; 
            color: #FFAB19;
            margin-bottom: 5px;
            filter: drop-shadow(0 8px 0 #CC8914);
            animation: float-icon 3s ease-in-out infinite;
        }

        /* è¦å‰‡èªªæ˜æ¡† (å³æ–¹) */
        .rules-box {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 4px solid #e0e6ed;
            text-align: left;
            min-width: 280px;
            animation: float-box 4s ease-in-out infinite;
            position: relative;
        }

        .rules-box h3 {
            color: #4C97FF;
            margin: 0 0 15px 0;
            text-align: center;
            font-size: 1.4rem;
            border-bottom: 2px dashed #eee;
            padding-bottom: 10px;
        }

        .rules-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #555;
        }

        .rules-list li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            margin-right: 8px;
            width: 60px;
            text-align: center;
        }
        .tag.correct { background-color: #4CBF56; box-shadow: 0 2px 0 #3A9E44; }
        .tag.wrong { background-color: #FF6680; box-shadow: 0 2px 0 #D9455F; }
        .tag.info { background-color: #FFAB19; box-shadow: 0 2px 0 #CC8914; }

        @keyframes float-icon {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }
        @keyframes float-box {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* å½ˆçª—å„ªåŒ– */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 15px;
            border-radius: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            border: 5px solid #fff;
        }

        .feedback-stage-wrapper {
            width: 100%;
            max-width: 100%; 
            aspect-ratio: 4 / 3;
            margin: 10px auto;
            border: 4px solid #FF6680;
            border-radius: 12px;
            background-color: #ffffff;
            overflow: hidden;
            display: block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            min-height: 200px; 
            flex-shrink: 0;
        }

        .hidden { display: none !important; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse-btn { animation: pulse 2s infinite; }

        @media (max-height: 700px) {
            h1.main-title { font-size: 2.5rem; margin: 5px 0; }
            .title-icon { font-size: 5rem; }
            .start-subtitle { font-size: 1.2rem; padding: 6px 20px; }
            .big-btn { font-size: 2rem; padding: 12px 50px; margin-top: 10px; }
        }
        
        /* æ‰‹æ©Ÿç›´å‘æ¨¡å¼ï¼šæ”¹ç‚ºä¸Šä¸‹æ’åˆ— */
        @media (max-width: 800px) {
            .start-screen {
                flex-direction: column;
                gap: 20px;
                padding-bottom: 20px;
                justify-content: center; /* ç½®ä¸­ */
            }
            
            /* åœ¨æ‰‹æ©Ÿä¸ŠæŠŠè¦å‰‡æ¡†ç¨å¾®ç¸®å°ä¸¦ç½®åº• */
            .rules-box {
                width: 90%;
                min-width: unset;
                padding: 15px;
                margin-top: 10px;
                animation: none; /* æ‰‹æ©Ÿä¸Šå–æ¶ˆæµ®å‹•é¿å…å¹²æ“¾ */
            }
            .rules-box h3 { font-size: 1.2rem; margin-bottom: 10px; }
            .rules-list { font-size: 1rem; }
            
            h1.main-title { font-size: 2.5rem; }
            .title-icon { font-size: 5rem; }
            .big-btn { font-size: 1.8rem; padding: 12px 40px; min-width: 220px; }
        }
    </style>
</head>
<body>

<!-- èƒŒæ™¯è£é£¾ -->
<i class="fas fa-star bg-star" style="top: 10%; left: 10%; font-size: 3rem;"></i>
<i class="fas fa-star bg-star" style="top: 20%; right: 15%; font-size: 2rem; animation-delay: 1s;"></i>
<i class="fas fa-star bg-star" style="bottom: 15%; left: 20%; font-size: 4rem; animation-delay: 2s;"></i>
<i class="fas fa-star bg-star" style="bottom: 10%; right: 10%; font-size: 2.5rem; animation-delay: 0.5s;"></i>

<nav class="navbar">
    <div class="nav-brand">
        <i class="fas fa-cat nav-cat-icon"></i>
        <span>æ˜Ÿæ˜Ÿåœ‹åº§æ¨™</span>
    </div>
    <div class="nav-links">
        <button class="nav-btn" onclick="sound.toggleUpdateIcon()">
            <i id="sound-icon" class="fas fa-volume-high"></i>
        </button>
        <button class="nav-btn" onclick="sound.playClick(); game.start()">
            <i class="fas fa-rotate-right"></i> é‡ä¾†
        </button>
    </div>
</nav>

<div class="container">
    <div class="game-content-wrapper">
        <div id="start-screen" class="start-screen">
            <!-- å·¦å´/ä¸Šæ–¹ï¼šä¸»è¦æ¨™é¡Œèˆ‡æŒ‰éˆ• -->
            <div class="start-content">
                <div class="title-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                
                <h1 class="main-title">
                    æ˜Ÿæ˜Ÿåœ‹<br>åº§æ¨™å¤§æŒ‘æˆ°
                </h1>
                
                <p class="start-subtitle">âœ¨ éš¨æ©ŸæŒ‘æˆ° 10 é¡Œï¼ âœ¨</p>
                
                <button class="game-btn big-btn pulse-btn" onclick="sound.init(); sound.playClick(); game.start()">
                    <i class="fas fa-play" style="margin-right: 15px; font-size: 0.8em;"></i>é–‹å§‹
                </button>
            </div>

            <!-- å³å´/ä¸‹æ–¹ï¼šè¨ˆåˆ†èªªæ˜æ¡† -->
            <div class="rules-box">
                <h3><i class="fas fa-calculator"></i> è¨ˆåˆ†èªªæ˜</h3>
                <ul class="rules-list">
                    <li><span class="tag correct">ç­”å°</span> ç²å¾— 10 åˆ†</li>
                    <li><span class="tag wrong">ç­”éŒ¯</span> ä¸æ‰£åˆ† (æœ‰è§£æ)</li>
                    <li><span class="tag info">æ»¿åˆ†</span> ç¸½å…± 100 åˆ†</li>
                    <li style="margin-top: 5px; font-size: 0.9em; color:#888; text-align:center;">
                        <i class="fas fa-flag-checkered"></i> åŠ æ²¹ï¼æˆç‚ºåº§æ¨™å¤§å¸«ï¼
                    </li>
                </ul>
            </div>
        </div>

        <div id="game-ui" class="hidden">
            <div class="status-bar">
                <span><i class="fas fa-flag"></i> é—œå¡: <span id="level-num">1</span>/10</span>
                <span><i class="fas fa-star"></i> å¾—åˆ†: <span id="score-num">0</span></span>
            </div>

            <div class="stage-container">
                <canvas id="stageCanvas"></canvas>
            </div>

            <div class="question-area">
                <!-- é¡Œç›®æ–‡å­—éš±è—ï¼Œä½†ä¿ç•™çµæ§‹ -->
                <div class="question-text">
                    è«‹å• <span id="target-name"></span> çš„åº§æ¨™ï¼Ÿ
                </div>
                <div class="options-grid" id="options-container"></div>
            </div>
        </div>

        <div id="end-screen" class="end-screen hidden">
            <div style="font-size: 7rem; margin-bottom: 10px; filter: drop-shadow(0 8px 0 rgba(0,0,0,0.1)); animation: float-icon 3s infinite;">ğŸ†</div>
            <h1 style="margin: 0; color: #4C97FF; font-size: 3rem; text-shadow: 3px 3px 0 #fff; font-weight:900;">æŒ‘æˆ°å®Œæˆï¼</h1>
            <p id="final-score" style="font-size: 4.5rem; font-weight: 900; color: #FFAB19; margin: 10px; text-shadow: 4px 4px 0 #fff, 6px 6px 0 rgba(0,0,0,0.1);">100 åˆ†</p>
            <div id="feedback-text" style="color:#555; margin-bottom: 25px; font-size: 1.5rem; font-weight:bold;">å¤ªå²å®³äº†ï¼</div>
            <button class="game-btn big-btn pulse-btn" onclick="sound.playClick(); game.start()">
                <i class="fas fa-rotate-right" style="margin-right: 15px; font-size: 0.8em;"></i>å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>
</div>

<!-- ç­”é¡Œå›é¥‹è¦–çª— -->
<div id="feedbackModal" class="modal hidden">
    <div class="modal-content" style="text-align: center;">
        <div id="feedback-title" style="font-size: 1.8rem; font-weight:900; margin-bottom:10px; text-shadow: 2px 2px 0 rgba(0,0,0,0.1);"></div>
        
        <!-- éŒ¯èª¤æ™‚é¡¯ç¤ºçš„åœ°åœ– -->
        <div id="feedback-stage-wrapper" class="feedback-stage-wrapper hidden">
            <canvas id="feedbackCanvas"></canvas>
        </div>
        
        <div id="feedback-explanation" style="text-align:left; background:#f9f9f9; padding:12px; border-radius:15px; margin-bottom:12px; border: 2px solid #eee;" class="hidden">
            <div style="font-weight:bold; margin-bottom:5px; font-size:1.1rem; color:#333;">æ­£ç¢ºç­”æ¡ˆï¼š<span id="correct-answer-text" style="color:#4C97FF; font-size:1.3rem;"></span></div>
            <div style="display:flex; align-items:center; gap:8px; margin:5px 0;">
                <span style="background:#FFAB19; color:white; padding:3px 8px; border-radius:6px; font-size:0.9rem; font-weight:bold; box-shadow: 0 3px 0 #CC8914;">X</span> 
                <span id="explain-x" style="font-size:1rem; font-weight:500;"></span>
            </div>
            <div style="display:flex; align-items:center; gap:8px; margin:5px 0;">
                <span style="background:#4C97FF; color:white; padding:3px 8px; border-radius:6px; font-size:0.9rem; font-weight:bold; box-shadow: 0 3px 0 #3373CC;">Y</span> 
                <span id="explain-y" style="font-size:1rem; font-weight:500;"></span>
            </div>
        </div>

        <button class="game-btn big-btn pulse-btn" onclick="sound.playClick(); game.nextQuestion()" style="font-size:1.4rem; width:100%; margin-top:5px; border-radius: 15px; min-width: unset; padding: 10px; box-shadow: 0 8px 0 #3373CC, 0 12px 15px rgba(0,0,0,0.2), inset 0 3px 0 rgba(255,255,255,0.4);">
            ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right" style="margin-left: 10px;"></i>
        </button>
    </div>
</div>

<script>
    class SoundManager {
        constructor() {
            this.ctx = null;
            this.enabled = true;
        }
        init() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            } else if (this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        }
        toggleUpdateIcon() {
            this.enabled = !this.enabled;
            const icon = document.getElementById('sound-icon');
            if (this.enabled) {
                icon.className = 'fas fa-volume-high';
                this.playClick();
            } else {
                icon.className = 'fas fa-volume-xmark';
            }
        }
        playTone(freq, type, duration, startTime = 0, vol = 0.1) {
            if (!this.enabled || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            const now = this.ctx.currentTime + startTime;
            osc.start(now);
            gain.gain.setValueAtTime(vol, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            osc.stop(now + duration);
        }
        playClick() { this.playTone(800, 'sine', 0.05, 0, 0.05); }
        playCorrect() {
            this.playTone(523.25, 'sine', 0.1, 0, 0.1);
            this.playTone(659.25, 'sine', 0.1, 0.08, 0.1);
            this.playTone(783.99, 'sine', 0.1, 0.16, 0.1);
            this.playTone(1046.50, 'sine', 0.3, 0.24, 0.1);
        }
        playWrong() {
            if (!this.enabled || !this.ctx) return;
            const now = this.ctx.currentTime;
            const osc1 = this.ctx.createOscillator();
            const gain1 = this.ctx.createGain();
            osc1.type = 'triangle';
            osc1.frequency.setValueAtTime(150, now);
            osc1.frequency.linearRampToValueAtTime(100, now + 0.2);
            osc1.connect(gain1);
            gain1.connect(this.ctx.destination);
            osc1.start(now);
            gain1.gain.setValueAtTime(0.1, now);
            gain1.gain.linearRampToValueAtTime(0, now + 0.2);
            osc1.stop(now + 0.2);
            const osc2 = this.ctx.createOscillator();
            const gain2 = this.ctx.createGain();
            osc2.type = 'triangle';
            osc2.frequency.setValueAtTime(100, now + 0.25);
            osc2.frequency.linearRampToValueAtTime(50, now + 0.55);
            osc2.connect(gain2);
            gain2.connect(this.ctx.destination);
            osc2.start(now + 0.25);
            gain2.gain.setValueAtTime(0.1, now + 0.25);
            gain2.gain.linearRampToValueAtTime(0, now + 0.55);
            osc2.stop(now + 0.55);
        }
        playWin() {
            if (!this.enabled || !this.ctx) return;
            const now = this.ctx.currentTime;
            const notes = [523.25, 523.25, 523.25, 659.25, 783.99, 1046.50]; 
            const times = [0, 0.15, 0.3, 0.45, 0.6, 0.9];
            const durs  = [0.1, 0.1, 0.1, 0.15, 0.2, 0.6];
            notes.forEach((f, i) => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.value = f;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const t = now + times[i];
                osc.start(t);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + durs[i]);
                osc.stop(t + durs[i]);
            });
        }
    }
    const sound = new SoundManager();

    const questionBank = [
        {name: "å°è²“", emoji: "ğŸ±", x: 0, y: 0}, {name: "è˜‹æœ", emoji: "ğŸ", x: 100, y: 0},
        {name: "ç±ƒçƒ", emoji: "ğŸ€", x: -140, y: 0}, {name: "æ˜Ÿæ˜Ÿ", emoji: "â­", x: 0, y: 120},
        {name: "æ„›å¿ƒ", emoji: "â¤ï¸", x: 0, y: -80}, {name: "ç«ç®­", emoji: "ğŸš€", x: 140, y: 100},
        {name: "æ°£çƒ", emoji: "ğŸˆ", x: 60, y: 140}, {name: "å¤ªé™½", emoji: "â˜€ï¸", x: 200, y: 160},
        {name: "è´è¶", emoji: "ğŸ¦‹", x: 80, y: 40}, {name: "ç¦®ç‰©", emoji: "ğŸ", x: 120, y: 120},
        {name: "è¥¿ç“œ", emoji: "ğŸ‰", x: 20, y: 20}, {name: "æ¼¢å ¡", emoji: "ğŸ”", x: 220, y: 80},
        {name: "çš‡å† ", emoji: "ğŸ‘‘", x: 100, y: 160}, {name: "é‘½çŸ³", emoji: "ğŸ’", x: 180, y: 20},
        {name: "å°ç‹—", emoji: "ğŸ¶", x: 60, y: 100}, {name: "é£›æ©Ÿ", emoji: "âœˆï¸", x: -140, y: 120},
        {name: "é›²æœµ", emoji: "â˜ï¸", x: -200, y: 140}, {name: "è¶³çƒ", emoji: "âš½", x: -100, y: 60},
        {name: "æ©Ÿå™¨äºº", emoji: "ğŸ¤–", x: -40, y: 100}, {name: "å¹½éˆ", emoji: "ğŸ‘»", x: -180, y: 80},
        {name: "é’è›™", emoji: "ğŸ¸", x: -220, y: 20}, {name: "çç›ƒ", emoji: "ğŸ†", x: -80, y: 140},
        {name: "éˆ´éº", emoji: "ğŸ””", x: -120, y: 60}, {name: "æœˆäº®", emoji: "ğŸŒ™", x: -200, y: 100},
        {name: "è™è ", emoji: "ğŸ¦‡", x: -40, y: 160}, {name: "èƒèŸ¹", emoji: "ğŸ¦€", x: -140, y: -100},
        {name: "ç‚¸å½ˆ", emoji: "ğŸ’£", x: -200, y: -140}, {name: "ä¼éµ", emoji: "ğŸ§", x: -60, y: -60},
        {name: "é›ªäºº", emoji: "â›„", x: -100, y: -120}, {name: "ç« é­š", emoji: "ğŸ™", x: -180, y: -80},
        {name: "ä»™äººæŒ", emoji: "ğŸŒµ", x: -220, y: -40}, {name: "è€é¼ ", emoji: "ğŸ­", x: -80, y: -160},
        {name: "é‘°åŒ™", emoji: "ğŸ”‘", x: -120, y: -60}, {name: "é­š", emoji: "ğŸŸ", x: -200, y: -20},
        {name: "éª·é«", emoji: "ğŸ’€", x: -40, y: -140}, {name: "çŒ´å­", emoji: "ğŸµ", x: 140, y: -100},
        {name: "é¦™è•‰", emoji: "ğŸŒ", x: 200, y: -140}, {name: "è»Šå­", emoji: "ğŸš—", x: 60, y: -60},
        {name: "æ¨¹æœ¨", emoji: "ğŸŒ³", x: 100, y: -120}, {name: "èŠ±æœµ", emoji: "ğŸŒº", x: 180, y: -80},
        {name: "Pizza", emoji: "ğŸ•", x: 220, y: -40}, {name: "ç†Šè²“", emoji: "ğŸ¼", x: 80, y: -160},
        {name: "è›‹ç³•", emoji: "ğŸ°", x: 120, y: -60}, {name: "å‰ä»–", emoji: "ğŸ¸", x: 200, y: -20},
        {name: "è‰è“", emoji: "ğŸ“", x: 40, y: -140}, {name: "æˆ¿å­", emoji: "ğŸ ", x: 220, y: 160},
        {name: "é–ƒé›»", emoji: "âš¡", x: -220, y: -160}, {name: "é›¨å‚˜", emoji: "â˜‚ï¸", x: 220, y: -160},
        {name: "é›ªèŠ±", emoji: "â„ï¸", x: -220, y: 160}, {name: "çœ¼ç›", emoji: "ğŸ‘€", x: -20, y: -20},
        {name: "è‘¡è„", emoji: "ğŸ‡", x: 160, y: 60}, {name: "æª¸æª¬", emoji: "ğŸ‹", x: -160, y: 40},
        {name: "æ¡ƒå­", emoji: "ğŸ‘", x: 40, y: -120}, {name: "é³³æ¢¨", emoji: "ğŸ", x: -60, y: -80},
        {name: "æ¤°å­", emoji: "ğŸ¥¥", x: 220, y: 140}, {name: "å¥‡ç•°æœ", emoji: "ğŸ¥", x: -220, y: -20},
        {name: "è–¯æ¢", emoji: "ğŸŸ", x: 120, y: 80}, {name: "ç†±ç‹—", emoji: "ğŸŒ­", x: -120, y: 140},
        {name: "ç”œç”œåœˆ", emoji: "ğŸ©", x: 80, y: -40}, {name: "é¤…ä¹¾", emoji: "ğŸª", x: -80, y: -60},
        {name: "ç³–æœ", emoji: "ğŸ¬", x: 180, y: 100}, {name: "æ£’æ£’ç³–", emoji: "ğŸ­", x: -180, y: 20},
        {name: "å†°æ·‡æ·‹", emoji: "ğŸ¦", x: 20, y: -140}, {name: "åˆ¨å†°", emoji: "ğŸ§", x: -40, y: -100},
        {name: "é£¯ç³°", emoji: "ğŸ™", x: 140, y: -20}, {name: "å£½å¸", emoji: "ğŸ£", x: -140, y: 60},
        {name: "éºµåŒ…", emoji: "ğŸ", x: 60, y: 160}, {name: "ç‰›è§’åŒ…", emoji: "ğŸ¥", x: -100, y: -140},
        {name: "é›è…¿", emoji: "ğŸ—", x: 200, y: -60}, {name: "é£²æ–™", emoji: "ğŸ¥¤", x: -200, y: 80},
        {name: "è­¦è»Š", emoji: "ğŸš“", x: 100, y: 120}, {name: "æ•‘è­·è»Š", emoji: "ğŸš‘", x: -100, y: 40},
        {name: "æ¶ˆé˜²è»Š", emoji: "ğŸš’", x: 40, y: -80}, {name: "è¨ˆç¨‹è»Š", emoji: "ğŸš•", x: -60, y: -120},
        {name: "å…¬è»Š", emoji: "ğŸšŒ", x: 220, y: -100}, {name: "è‡ªè¡Œè»Š", emoji: "ğŸš²", x: -220, y: 100},
        {name: "æ»‘æ¿", emoji: "ğŸ›¹", x: 160, y: -160}, {name: "å¸†èˆ¹", emoji: "â›µ", x: -160, y: -40},
        {name: "ç›´å‡æ©Ÿ", emoji: "ğŸš", x: 0, y: 160}, {name: "é£›ç¢Ÿ", emoji: "ğŸ›¸", x: 0, y: -140}
    ];

    class ScratchGame {
        constructor() {
            this.canvas = document.getElementById('stageCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.currentQuestions = [];
            this.currentIndex = 0;
            this.score = 0;
            this.totalQuestions = 10;
            this.resizeCanvas();
            window.addEventListener('resize', () => this.resizeCanvas());
        }

        resizeCanvas() {
            const container = document.querySelector('.stage-container');
            const rect = container.getBoundingClientRect();
            // ç¢ºä¿ç•«å¸ƒè‡³å°‘æœ‰ 1pxï¼Œé¿å…éŒ¯èª¤
            if (rect.width > 0 && rect.height > 0) {
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                if(this.currentQuestions.length > 0 && this.currentIndex < this.totalQuestions) {
                    this.drawStage(this.ctx, this.canvas, this.currentQuestions[this.currentIndex], false);
                }
            }
        }

        toCanvasX(scratchX, w) { return (scratchX + 240) * (w / 480); }
        toCanvasY(scratchY, h) { return (180 - scratchY) * (h / 360); }

        drawGrid(ctx, w, h) {
            ctx.clearRect(0, 0, w, h);
            ctx.lineWidth = 1;
            
            // ç´°æ ¼ç·š
            ctx.strokeStyle = '#e0e0e0';
            ctx.beginPath();
            for(let x = -240; x <= 240; x += 20) {
                if (x % 100 === 0) continue;
                let cx = this.toCanvasX(x, w);
                ctx.moveTo(cx, 0); ctx.lineTo(cx, h);
            }
            for(let y = -180; y <= 180; y += 20) {
                if (y % 100 === 0) continue;
                let cy = this.toCanvasY(y, h);
                ctx.moveTo(0, cy); ctx.lineTo(w, cy);
            }
            ctx.stroke();

            // ä¸»æ ¼ç·š
            ctx.strokeStyle = '#999999';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for(let x = -200; x <= 200; x += 100) {
                if (x === 0) continue;
                let cx = this.toCanvasX(x, w);
                ctx.moveTo(cx, 0); ctx.lineTo(cx, h);
            }
            for(let y = -100; y <= 100; y += 100) {
                if (y === 0) continue;
                let cy = this.toCanvasY(y, h);
                ctx.moveTo(0, cy); ctx.lineTo(w, cy);
            }
            ctx.stroke();

            // è»¸
            let cx0 = this.toCanvasX(0, w);
            let cy0 = this.toCanvasY(0, h);
            ctx.lineWidth = 3;
            
            ctx.strokeStyle = '#FFAB19'; // Xè»¸
            ctx.beginPath(); ctx.moveTo(0, cy0); ctx.lineTo(w, cy0); ctx.stroke();
            
            ctx.strokeStyle = '#4C97FF'; // Yè»¸
            ctx.beginPath(); ctx.moveTo(cx0, 0); ctx.lineTo(cx0, h); ctx.stroke();

            // æ–‡å­—
            let fs = Math.max(10, w / 45); 
            ctx.fillStyle = '#666';
            ctx.font = `bold ${fs}px Arial`;
            
            ctx.textAlign = 'center'; ctx.textBaseline = 'top';
            for(let x = -200; x <= 200; x += 100) {
                if (x === 0) continue;
                ctx.fillText(x.toString(), this.toCanvasX(x, w), cy0 + 4);
            }
            ctx.fillText("X", w - 10, cy0 - 20);

            ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
            for(let y = -100; y <= 100; y += 100) {
                if (y === 0) continue;
                ctx.fillText(y.toString(), cx0 - 4, this.toCanvasY(y, h));
            }
            ctx.textAlign = 'center';
            ctx.fillText("Y", cx0 + 15, 10);
            
            ctx.textAlign = 'right'; ctx.textBaseline = 'top';
            ctx.fillStyle = '#333';
            ctx.fillText("0", cx0 - 4, cy0 + 4);
        }

        drawStage(ctx, canvas, q, showGuides) {
            let w = canvas.width, h = canvas.height;
            this.drawGrid(ctx, w, h);
            
            let cx = this.toCanvasX(q.x, w);
            let cy = this.toCanvasY(q.y, h);
            // æ”¾å¤§ç‰©å“é¡¯ç¤ºæ¯”ä¾‹
            let itemSize = (w / 480) * 45; 

            if (showGuides) {
                ctx.setLineDash([5, 5]); ctx.lineWidth = 2;
                ctx.strokeStyle = '#FFAB19'; ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx, this.toCanvasY(0, h)); ctx.stroke();
                ctx.strokeStyle = '#4C97FF'; ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(this.toCanvasX(0, w), cy); ctx.stroke();
                ctx.setLineDash([]);
            }

            ctx.font = `${itemSize}px Arial`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(q.emoji, cx, cy);

            let bgDot = Math.max(4, itemSize * 0.2);
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.beginPath(); ctx.arc(cx, cy, bgDot, 0, Math.PI*2); ctx.fill();

            ctx.fillStyle = '#FF0000';
            ctx.beginPath(); ctx.arc(cx, cy, bgDot*0.6, 0, Math.PI*2); ctx.fill();
            
            if (!showGuides) {
                ctx.strokeStyle = 'rgba(255,0,0,0.5)'; ctx.lineWidth = 1;
                let cr = itemSize * 0.3;
                ctx.beginPath(); ctx.moveTo(cx-cr, cy); ctx.lineTo(cx+cr, cy); ctx.moveTo(cx, cy-cr); ctx.lineTo(cx, cy+cr); ctx.stroke();
            }
        }

        start() {
            const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
            this.currentQuestions = shuffled.slice(0, this.totalQuestions);
            this.currentIndex = 0;
            this.score = 0;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            setTimeout(() => { this.resizeCanvas(); this.loadLevel(); }, 50);
        }

        loadLevel() {
            if (this.currentIndex >= this.totalQuestions) { this.endGame(); return; }
            const q = this.currentQuestions[this.currentIndex];
            document.getElementById('level-num').innerText = this.currentIndex + 1;
            document.getElementById('score-num').innerText = this.score;
            document.getElementById('target-name').innerText = q.name + " " + q.emoji;
            this.drawStage(this.ctx, this.canvas, q, false);
            this.generateOptions(q);
        }

        generateOptions(correctQ) {
            const options = [{text: `(${correctQ.x}, ${correctQ.y})`, isCorrect: true}];
            const set = new Set(); set.add(options[0].text);
            
            let attempts = 0;
            while(options.length < 4) {
                attempts++;
                let dx = correctQ.x, dy = correctQ.y;
                
                if (attempts < 20) {
                    let r = Math.random();
                    if(r < 0.25) { dx = -dx; } 
                    else if(r < 0.5) { dy = -dy; }
                    else if(r < 0.75) { dx = -dx; dy = -dy; }
                    else { let tmp = dx; dx = dy; dy = tmp; }
                    
                    if (dx === correctQ.x && dy === correctQ.y) {
                        dx += (Math.random()>0.5?20:-20);
                    }
                } else {
                    dx = Math.floor((Math.random() * 24) - 12) * 20;
                    dy = Math.floor((Math.random() * 18) - 9) * 20;
                    if (dx < -240) dx = -240; if (dx > 240) dx = 240;
                    if (dy < -180) dy = -180; if (dy > 180) dy = 180;
                }

                let txt = `(${dx}, ${dy})`;
                if(!set.has(txt)) { 
                    set.add(txt); 
                    options.push({text: txt, isCorrect: false}); 
                }
                if (attempts > 100) break;
            }
            
            while(options.length < 4) {
                 let dx = Math.floor(Math.random() * 20) * 20 - 200;
                 let dy = Math.floor(Math.random() * 15) * 20 - 150;
                 let txt = `(${dx}, ${dy})`;
                 if(!set.has(txt)) {
                     set.add(txt);
                     options.push({text: txt, isCorrect: false});
                 }
            }

            options.sort(() => 0.5 - Math.random());
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'game-btn option-btn'; 
                btn.innerText = opt.text;
                btn.onclick = (e) => {
                    sound.playClick();
                    this.checkAnswer(opt, e.target); 
                };
                container.appendChild(btn);
            });
        }

        checkAnswer(opt, btn) {
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => b.disabled = true);
            const q = this.currentQuestions[this.currentIndex];
            const modal = document.getElementById('feedbackModal');
            // const icon = document.getElementById('feedback-icon'); // Removed
            const title = document.getElementById('feedback-title');
            // const target = document.getElementById('feedback-target-display'); // Removed
            const wrapper = document.getElementById('feedback-stage-wrapper');
            const explanation = document.getElementById('feedback-explanation');

            // target.innerText = ...; // Removed

            if(opt.isCorrect) {
                sound.playCorrect();
                btn.classList.add('correct');
                this.score += 10; 
                // icon.innerHTML = 'ğŸ‰'; // Removed
                title.innerText = 'ğŸ‰ ç­”å°äº†ï¼';
                title.style.color = '#4CBF56';
                wrapper.classList.add('hidden');
                explanation.classList.add('hidden');
            } else {
                sound.playWrong();
                btn.classList.add('wrong');
                // this.score -= 10; // Removed penalty
                btns.forEach(b => { if(b.innerText === `(${q.x}, ${q.y})`) b.classList.add('correct'); });
                // icon.innerHTML = 'ğŸ¤”'; // Removed
                title.innerText = 'ğŸ¤” å“å‘€ï¼Œç­”éŒ¯äº†ï¼';
                title.style.color = '#FF6680';
                wrapper.classList.remove('hidden');
                explanation.classList.remove('hidden');
                document.getElementById('correct-answer-text').innerText = `(${q.x}, ${q.y})`;
                document.getElementById('explain-x').innerText = q.x > 0 ? `å¾€å³ ${q.x}` : (q.x < 0 ? `å¾€å·¦ ${q.x}` : "ä¸­é–“ 0");
                document.getElementById('explain-y').innerText = q.y > 0 ? `å¾€ä¸Š ${q.y}` : (q.y < 0 ? `å¾€ä¸‹ ${q.y}` : "ä¸­é–“ 0");
            }
            
            setTimeout(() => {
                modal.classList.remove('hidden');
                if(!wrapper.classList.contains('hidden')) {
                    requestAnimationFrame(() => {
                        let w = wrapper.clientWidth || 250;
                        
                        if (!w || w === 0) {
                             w = Math.min(300, window.innerWidth - 60);
                             wrapper.style.width = w + 'px';
                        }

                        let h = w * 0.75;
                        wrapper.style.height = h + 'px'; // Force height

                        let cvs = document.getElementById('feedbackCanvas');
                        cvs.width = w; cvs.height = h;
                        
                        this.drawStage(cvs.getContext('2d'), cvs, q, true);
                    });
                }
            }, 100);
        }

        nextQuestion() {
            document.getElementById('feedbackModal').classList.add('hidden');
            this.currentIndex++;
            this.loadLevel();
        }

        endGame() {
            sound.playWin();
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            let final = this.score; // 10 questions * 10 = 100
            if (final < 0) final = 0; 
            document.getElementById('final-score').innerText = final + " åˆ†";
            document.getElementById('feedback-text').innerText = final===100?"å¤ªç¥äº†ï¼":final>=60?"å¾ˆæ£’å–”ï¼":"å†åŠ æ²¹ï¼";
        }
    }
    const game = new ScratchGame();
</script>
</body>
</html>